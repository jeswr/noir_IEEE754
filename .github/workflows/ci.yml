name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # Generate tests job - must run first to produce both tests and CI matrix
  generate-tests:
    runs-on: ubuntu-latest
    outputs:
      test-groups: ${{ steps.matrix.outputs.groups }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Generate IEEE 754 tests and CI matrix
        run: python3 scripts/generate_tests.py --all --packages --synthetic-f64 --generate-f64 --output-dir test_packages --ci-matrix .github/test-matrix.json

      - name: Read test matrix
        id: matrix
        run: |
          if [ ! -f .github/test-matrix.json ]; then
            echo "Error: test-matrix.json not found"
            exit 1
          fi
          # Note: Cannot use GROUPS as variable name - it's a reserved bash variable (user group IDs)
          TEST_GROUPS=$(jq -c '.groups' .github/test-matrix.json)
          echo "groups=${TEST_GROUPS}" >> $GITHUB_OUTPUT
          echo "Test groups: $(jq '.groups | length' .github/test-matrix.json) groups"

      - name: Upload generated tests
        uses: actions/upload-artifact@v6
        with:
          name: ieee754-tests
          path: test_packages/
          retention-days: 1

  # Read Noir versions from config file
  setup:
    runs-on: ubuntu-latest
    outputs:
      noir-versions: ${{ steps.versions.outputs.versions }}
      latest-version: ${{ steps.versions.outputs.latest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Read Noir versions
        id: versions
        run: |
          VERSIONS=$(jq -c '.versions' .github/noir-versions.json)
          LATEST=$(jq -r '.latest' .github/noir-versions.json)
          echo "versions=$VERSIONS" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "Noir versions: $VERSIONS"
          echo "Latest version: $LATEST"

  # Lint and format check
  lint:
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        noir-version: ${{ fromJson(needs.setup.outputs.noir-versions) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Noir
        uses: noir-lang/noirup@v0.1.4
        with:
          toolchain: ${{ matrix.noir-version }}

      - name: Check format
        run: nargo fmt --check --package ieee754

  # Run unit tests on all Noir versions
  unit-tests:
    runs-on: ubuntu-latest
    needs: [setup]
    strategy:
      fail-fast: false
      matrix:
        noir-version: ${{ fromJson(needs.setup.outputs.noir-versions) }}
    name: unit-tests (${{ matrix.noir-version }})
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Noir
        uses: noir-lang/noirup@v0.1.4
        with:
          toolchain: ${{ matrix.noir-version }}

      - name: Run unit tests
        run: |
          echo "Running unit tests"
          nargo test --package ieee754_unit_tests test_float32 || exit 1
          nargo test --package ieee754_unit_tests test_float64 || exit 1

  # Run IEEE 754 test suite only on latest Noir version
  ieee754-tests:
    runs-on: ubuntu-latest
    needs: [setup, generate-tests]
    strategy:
      fail-fast: false
      matrix:
        group: ${{ fromJson(needs.generate-tests.outputs.test-groups) }}
        exclude:
          - group:
              module: "_unit_"
    name: ieee754 (${{ matrix.group.name }})
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download generated tests
        uses: actions/download-artifact@v7
        with:
          name: ieee754-tests
          path: test_packages/

      - name: Install Noir
        uses: noir-lang/noirup@v0.1.4
        with:
          toolchain: ${{ needs.setup.outputs.latest-version }}

      - name: Add test packages to workspace
        run: |
          python3 << 'EOF'
          import os
          import glob
          
          # Find all test packages
          packages = sorted(glob.glob("test_packages/ieee754_*"))
          packages = [p for p in packages if os.path.isdir(p)]
          
          print(f"Found {len(packages)} test packages")
          
          # Generate Nargo.toml
          members = ['    "ieee754"', '    "ieee754_unit_tests"']
          members.extend(f'    "{pkg}"' for pkg in packages)
          
          content = "[workspace]\nmembers = [\n" + ",\n".join(members) + "\n]\n"
          
          with open("Nargo.toml", "w") as f:
              f.write(content)
          
          print("Updated Nargo.toml:")
          print(content)
          EOF

      - name: Run tests - ${{ matrix.group.name }}
        run: |
          PACKAGE="${{ matrix.group.package }}"
          echo "Running all tests in package: $PACKAGE"
          nargo test --package "$PACKAGE" || exit 1
        shell: bash

  # Summary job that depends on all test jobs
  test-summary:
    runs-on: ubuntu-latest
    needs: [setup, lint, unit-tests, ieee754-tests, generate-tests]
    if: always()
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.setup.result }}" != "success" ]; then
            echo "Setup failed"
            exit 1
          fi
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "Lint failed"
            exit 1
          fi
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "Unit tests failed"
            exit 1
          fi
          if [ "${{ needs.ieee754-tests.result }}" != "success" ]; then
            echo "IEEE 754 tests failed"
            exit 1
          fi
          if [ "${{ needs.generate-tests.result }}" != "success" ]; then
            echo "Test generation failed"
            exit 1
          fi
          echo "All checks passed!"
